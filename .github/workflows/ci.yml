on: push
permissions: write-all
jobs:
    replicate-file:
        runs-on: ubuntu-latest
        name: image edit

        steps:
        - name: Checkout source repo
          uses: actions/checkout@v2
          with:
            path: ./dh-vaultwarden

        - name: Checkout kustomize repo
          uses: actions/checkout@v2
          with: 
            repository: "${{ github.repository_owner }}/kustomize"
            token: ${{ secrets.ACTIONS_TOKEN }}
            path: ./kustomize
            
#         - name: Set foobar to cool
#           uses: mikefarah/yq@master
#           with:
#             cmd: cd ./kustomize/vault ; yq -i '.images[0].newTag = "\${{github.ref_name}}-\${{github.sha::7}}"' 'kustomization.yaml'

        - name: Replace image 
          if: github.ref == ref/head/main
          run: |
             sudo apt-key adv --keyserver keyserver.ubuntu.com --recv-keys CC86BB64
             sudo add-apt-repository ppa:rmescandon/yq
             sudo apt update
             sudo apt install yq -y
             yq --version
             source <(yq shell-completion bash)
             #echo -e "images: \n\v- name: vaultwarden   \n  \vvewName: sohag/vaultwarden  \n  \vnewTag: sohag/vaultwarden:${{github.ref_name}}-${GITHUB_SHA::7}" >> ./kustomize/vault/kustomization.yaml
             #sed -i 's/some_tag/sohag\/vaultwarden:\${{github.ref_name}}-\${GITHUB_SHA::7}/g' ./kustomize/vault/kustomization.yaml
             #if: ${{ github.ref == 'ref/head/main' }}
             cd ./kustomize/overlays/prod
             yq e -i '.images[0].newTag = "${{github.ref_name}} - ${{github.sha}}"' 'kustomization.yaml
               
        - name: Replace image 
          if: github.ref == ref/head/staging
          run: |
              cd ./kustomize/overlays/stg
              yq e -i '.images[0].newTag = "${{github.ref_name}} - ${{github.sha}}"' 'kustomization.yaml'
             
        - name: "commander"
          run: ls -lA ./kustomize; cat ./kustomize/vault/kustomization.yaml
        - name: "save image name"
          run: |
            cd ./kustomize
            git config --local user.name "${{ github.repository_owner }}"
            git config --local user.email "${{ github.repository_owner }}@users.noreply.github.com"
            git add .
            git commit -m "image edit and push"
            git status

        - name: "check config"
          run: |
            cd ./kustomize
            git config -l
        - name: "push you"
          run: |
            cd ./kustomize
            git push origin main
####
